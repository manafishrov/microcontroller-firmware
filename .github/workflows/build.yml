name: Release Build

on:
  push:
    tags:
      - v[0-9]+.[0-9]+.[0-9]+*

permissions:
  contents: write

jobs:
  build-usb-flashing-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Arm GNU Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential gcc-arm-none-eabi libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib

      - name: Configure CMake for Pico
        run: |
          mkdir -p build/pico
          cd build/pico
          cmake -S $GITHUB_WORKSPACE -B . -DCMAKE_BUILD_TYPE=Release -DPICO_SDK_FETCH_FROM_GIT=ON

      - name: Build Firmware for Pico
        run: |
          cd build/pico
          cmake --build .

      - name: Configure CMake for Pico 2
        run: |
          mkdir -p build/pico2
          cd build/pico2
          cmake -S $GITHUB_WORKSPACE -B . -DCMAKE_BUILD_TYPE=Release -DPICO_SDK_FETCH_FROM_GIT=ON -DPICO_BOARD=pico2

      - name: Build Firmware for Pico 2
        run: |
          cd build/pico2
          cmake --build .

      - name: Rename Assets for Release
        run: |
          cp build/pico/pwm.uf2 pwm-pico.uf2
          cp build/pico/dshot.uf2 dshot-pico.uf2
          cp build/pico2/pwm.uf2 pwm-pico2.uf2
          cp build/pico2/dshot.uf2 dshot-pico2.uf2

      - name: Create Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: 'Release assets for ${{ github.ref_name }}.'
          draft: true
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            pwm-pico.uf2
            dshot-pico.uf2
            pwm-pico2.uf2
            dshot-pico2.uf2
