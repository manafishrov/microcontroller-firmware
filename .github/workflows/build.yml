name: Release Build

on:
  push:
    tags:
      - v[0-9]+.[0-9]+.[0-9]+*

permissions:
  contents: write

jobs:
  build-usb-flashing-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Arm GNU Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential gcc-arm-none-eabi libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib

      - name: Configure CMake for Pico
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DPICO_SDK_FETCH_FROM_GIT=ON

      - name: Build Firmware for Pico
        run: |
          cd build
          cmake --build .

       - name: Configure CMake for Pico 2
         run: |
           cd build
           cmake .. -DCMAKE_BUILD_TYPE=Release -DPICO_SDK_FETCH_FROM_GIT=ON -DPICO_PLATFORM=rp2350-arm-s -DPICO_BOARD=pico2

      - name: Build Firmware for Pico 2
        run: |
          cd build
          cmake --build .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: 'Release assets for ${{ github.ref_name }}.'
          draft: true
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            build/dshot-pico.uf2
            build/pwm-pico.uf2
            build/dshot-pico2.uf2
            build/pwm-pico2.uf2
